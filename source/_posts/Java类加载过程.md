---
title: Java类加载过程
categories: 
 - 技术
tags:
 - Java
---

一个Java类在编码到最终执行一般包括两个过程:
- 编译: 就是把我们编写的.java文件通过javac命令编译成字节码,也就是我们常说的.class文件.
- 运行: 把编译生成的.class文件交给java虚拟机执行

我们经常说的java类加载过程就是指,把编译生成的.class文件中的类信息加载到内存,并解析生成对应的类对象的过程.

这主要分为五个阶段:
##### 加载
简单来说,就是把.class字节码文件从各个来源通过类加载器装载进java虚拟机的过程.
- 来源: 本地编译生成的.class文件、jar包中的.class文件、网络网络以及动态代理实时编译.
- 类加载器:BootStrapClassLoader、ExtensionClassLoader、AppClassLoader和自定义类加载器.

##### 验证
主要是为了保证加载进来的字节流符合虚拟机规范，不会造成安全错误。

- 包括对于文件格式的验证，比如常量中是否有不被支持的常量？文件中是否有不规范的或者附加的其他信息？

- 对于元数据的验证，比如该类是否继承了被final修饰的类？类中的字段，方法是否与父类冲突？是否出现了不合理的重载？

- 对于字节码的验证，保证程序语义的合理性，比如要保证类型转换的合理性。

- 对于符号引用的验证，比如校验符号引用中通过全限定名是否能够找到对应的类？校验符号引用中的访问性（private，public等）是否可被当前类访问？

##### 准备
主要为类变量分配内存,赋初值.(默认值而不是代码中具体的初始值,比如引用对象类型赋为null)

##### 解析
将常量池内的符号引用替换为直接引用的过程。

两个重点：

符号引用。即一个字符串，但是这个字符串给出了一些能够唯一性识别一个方法，一个变量，一个类的相关信息。
直接引用。可以理解为一个内存地址，或者一个偏移量。比如类方法，类变量的直接引用是指向方法区的指针；而实例方法，实例变量的直接引用则是从实例的头指针开始算起到这个实例变量位置的偏移量
举个例子来说，现在调用方法hello()，这个方法的地址是1234567，那么hello就是符号引用，1234567就是直接引用。

在解析阶段，虚拟机会把所有的类名，方法名，字段名这些符号引用替换为具体的内存地址或偏移量，也就是直接引用。

原来只是一些符号,现在替换为内存地址或偏移量.

##### 初始化
这个阶段主要是对类变量初始化，是执行类构造器的过程。

对static修饰的变量或语句进行初始化。

如果初始化一个类的时候，其父类尚未初始化，则优先初始化其父类。

如果同时包含多个静态变量和静态代码块，则按照自上而下的顺序依次执行。




