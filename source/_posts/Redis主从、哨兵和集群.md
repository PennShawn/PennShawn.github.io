---
title: Redis主从、哨兵和集群
categories: 
 - 技术
tags:
 - Java
 - redis
---

#### 1.主从
redis主从指的是启动多个redi实例,一个当作主节点,支持读写操作,其他的实例当作从节点,支持读操作和主节点的同步写操作.这样当有大量的读操作时,就可以分散主节点的压力.主服务器每执行完一次写命令都会向从服务器同步相同的命令,让从服务器和主服务器保持数据一致性.

##### 优点
主从复制,读写分离.可以降低主服务器的读操作压力.并且主服务器向从服务器的同步操作是非阻塞的,不会影响客户端向主服务器的请求.

##### 缺点
- 不具备自动容错和恢复功能.主机或者从机宕机后都要等待重启或者手动更换ip才能恢服务.
- 主机宕机,宕机时可能有部分数据没有同步到从机,切换ip后会有数据不一致的问题.
- 比较难支持在线扩容,集群容量到达上限时在线扩容会变得比较复杂.


#### 2.哨兵模式
主从模式中,主服务器服务中断后,需要手动将一个从服务器升级为主服务器.为此,redis提供了哨兵模式实现自动化的进行系统监控和故障恢复功能.

哨兵模式会监控主服务器和从服务器的状态,当主服务器挂掉后,会选举一个从服务器来当新的主服务器.

##### 优点
主从模式有的优点它都有,而且支持故障自动恢复,可用性更高.

#### 3.集群
redis的哨兵模式中,每台redis服务器存储的都是同一份数据,很浪费内存.所以redis提供了cluster模式,实现了redis的分布式存储.

redis-Cluster采用无中心结构
1. 所有的redis结点彼此互联(PING_PONG机制),内部使用二进制协议优化传输速率和带宽.
2. 当超过半数节点检测到一个节点失效时整个集群才会判定一个节点失效.
3. 客户端和redis节点是直连的,不需要中间代理层.和任意一个可用的节点连接就行.


##### 集群的工作方式
redis集群的存储方式是和插槽挂钩的,一总共定义了16384个槽,这16384个槽是按照设置被分配到不同的redis节点上的，比如启动了三个redis实例：cluster-A，cluster-B和cluster-C，这里将0-5460号槽分配给cluster-A，将5461-10922号槽分配给cluster-B，将10923-16383号槽分配给cluster-C（总共有16384个槽，但是其标号类似数组下标，是从0到16383）。也就是说数据的存储只和槽有关，并且槽的数量是一定的，由于一致hash算法是一定的，因而将这16384个槽分配给无论多少个redis实例，对于确认的数据其都将被分配到确定的槽位上。redis集群通过这种方式来达到redis的高效和高可用性目的。

位置分配的过程如下:
1. 把16384槽按照节点数量进行平均分配，由节点进行管理
2. 对每个key按照CRC16规则进行hash运算
3. 把hash结果对16383进行取余
4. 把余数发送给Redis节点
5. 节点接收到数据，验证是否在自己管理的槽编号的范围<br>
    如果在自己管理的槽编号范围内，则把数据保存到数据槽中，然后返回执行结果<br>
    如果在自己管理的槽编号范围外，则会把数据发送给正确的节点，由正确的节点来把数据保存在对应的槽中

##### 没有采用一致性hash算法
因为一致性hash算法可能会造成分配不均匀,redis集群采用hash槽,节点分配多少hash槽由用户自定义.

##### 集群的高可用
槽位的转移和分配都由人工配置,不会自动进行,集群的高可用指的是节点的主从复制和自动回复,主节点挂了会选举从节点为新的主节点.

##### 缺点
批量操作mset、mget等,当操作的key在不同的槽上的时候,是不允许批量操作的.redis会报错

可以使用hastTag即在key前面加上{xxx}相同的内容,当格式为`{xxx}`的时候,只有`{}`中的内容才会被用来计算hash值,所以可以控制这些值在同一个hash槽中.
