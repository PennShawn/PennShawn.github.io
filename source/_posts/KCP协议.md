---
title: KCP协议
categories :
- 技术
tags :
- kcp 
- 网络
---

KCP是一个快速可靠协议,它设计的主要目的师稳了解决在网络拥堵的情况下TCP协议网络速度慢的问题,增大网络传输速率,但相对TCP,会相应的牺牲一部分带宽.
KCP没有规定下车呢个传输协议,一般用UDP作为下层协议.KCP层在UDP的数据报文的基础上增加控制头.当用户数据很大,大于一个UDP包能承担的范围时(大于MSS),KCP会将用户的数据分片存储在多个KCP包中.每个KCP包称为一个分片.

### 一些网络协议的基本概念
####超时与重传
发送数据包在一定的时间内没有接收到相应的ACK,等待一定的事件,超时之后就认为这个数据包丢失,就会重新发送.这个等待的事件称为RTO,即重传超时时间.
####滑动窗口
 TCP通过确认机制来保证数据传输的可靠性,在早起的时候,发送数据方会在发送数据之后启动定时器,在一定时间内,如果没有收到发送数据包的ACK报文,就会重新发送数据,知道发送成功为止.但这种停等的机制必须等待确认之后才能发送下一个包,传输速度比较慢.
 为了提高传输速度,发送方不必再每发送一个包之后就进行等待确认,而是发送多个包出去,然后等待接收方一一确认.但是接收方不可能同时处理无限多的数据,因此需要发送方往网络中发送的数据数量.接收方在未收到确认之前,发送方只能发送wnd大小的额数据,这个机制叫做滑动窗口机制.tcp每一端都可以收发数据,每个TCP连接的两端都维护一个发送窗口和接受窗口结构.
#### KCP结构字段的含义
snd_una:第一个未确认的包
snd_nxt:下一个等待分配的包的序号

####_KCP通过以下方式提高速率_
1. RTO
 TCP的RTO是以2倍的方式来计算的,当丢包的次数多的时候,重传超时的RTO就非常非常的大了,重传就非常慢,效率低,性能差.而KCP的RTO可以以1.5倍的速度增长,相对于TCP来说,有更短的重传时间.

2. 快速重传机制——无延迟ACK回复模式
 假如开启KCP的快速重传机制,并且设置了当重复的ACK个数数大于resend时候，直接进行重传。 当发送端发送了1,2,3,4,5五个包，然后收到远端的ACK：1,3,4,5。当收到ACK3时，KCP知道2被跳过1次，当收到ACK4的时候，KCP知道2被跳过2次，当次数大于等于设置的resend的值的时候，不用等到超时，可直接重传2号包。这就是KCP的快速重传机制。
3. 选择重传 
KCP采用滑动窗口机制来提高发送速度。由于UDP是不可靠的传输方式，会存在丢包和薄、包的乱序。而KCP是可靠的且保证数据有序的协议。为了保证包的顺序，接收方会维护一个接收窗口，接收窗口有一个起始序号 rcv_nxt（待接收消息序号）以及尾序号 rcv_nxt + rcv_wnd（接收窗口大小）。如果接收窗口收到序号为 rcv_nxt 的分片（刚好是接收端待接收的消息序号），那么 rcv_nxt 就加一，也就是滑动窗口右移，并把该数据放入接收队列供应用层取用。如果收到的数据在窗口范围内但不是 rcv_nxt ，那么就把数据保存起来，等收到rcv_nxt序号的分片时再一并放入接收队列供应用层取用。 
当丢包发生的时候，假设第n个包丢失了，但是第n+1,n+2个包都已经传输成功了，此时只重传第n个包，二部重传成功传输的n+1,n+2号包，这就是选择重传。为了能够做到选择重传，接收方需要告诉发送方哪些包它收到了。比如在返回的ACK中包含rcv_nxt和sn，rcv_nxt的含义是接收方已经成功按顺序接收了rcv_nxt序号之前的所有包，大于rcv_nxt的序号sn表示的是在接收窗口内的不连续的包。那么根据这两个参数就可以计算出哪些包没有收到了。发送方接收到接收方发过来的数据时，首先解析rcv_nxt，把所有小于rcv_nxt序号的包从发送缓存队列中移除。然后再解析sn（大于rcv_nxt），遍历发送缓存队列，找到所有序号小于sn的包，根据我们设置的快速重传的门限，对每个分片维护一个快速重传的计数，每收到一个ack解析sn后找到了一个分片，就把该分片的快速重传的计数加一，如果该计数达到了快速重传门限，那么就认为该分片已经丢失，可以触发快速重传，该门限值在kcp中可以设置。 
4. 拥塞窗口 
当网络状态不好的时候，KCP会限制发送端发送的数据量，这就是拥塞控制。拥塞窗口（cwnd）会随着网络状态的变化而变化。这里采用了慢启动机制，慢启动也就是控制拥塞窗口从0开始增长，在每收到一个报文段确认后，把拥塞窗口加1，多增加一个MSS的数值。但是为了防止拥塞窗口过大引起网络阻塞，还需要设置一个慢机制的的门限（ssthresh即拥塞窗口的阈值）。当拥塞窗口增长到阈值以后，就减慢增长速度，缓慢增长。 
但是当网络很拥堵的情况下，导致发送数据出现重传时，这时说明网络中消息太多了，用户应该减少发送的数据，也就是拥塞窗口应该减小。怎么减小呢，在快速重传的情况下，有包丢失了但是有后续的包收到了，说明网络还是通的，这时采取拥塞窗口的退半避让,拥塞窗口减半，拥塞门限减半。减小网络流量，缓解拥堵。当出现超时重传的时候，说明网络很可能死掉了，因为超时重传会出现，原因是有包丢失了，并且该包之后的包也没有收到，这很有可能是网络死了，这时候，拥塞窗口直接变为1，不再发送新的数据，直到丢失的包传输成功。 


参考:https://blog.csdn.net/qq_36748278/article/details/80171575
